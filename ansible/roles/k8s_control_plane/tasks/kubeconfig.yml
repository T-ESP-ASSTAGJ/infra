---
# Configure kubectl access for the admin user

- name: Create .kube directory for admin user
  ansible.builtin.file:
    path: "/home/{{ k8s_admin_user }}/.kube"
    state: directory
    owner: "{{ k8s_admin_user }}"
    group: "{{ k8s_admin_user }}"
    mode: '0755'

- name: Copy admin.conf to user's kubeconfig
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: "{{ k8s_kubeconfig_path }}"
    owner: "{{ k8s_admin_user }}"
    group: "{{ k8s_admin_user }}"
    mode: '0600'
    remote_src: yes

- name: Set KUBECONFIG environment variable in .bashrc
  ansible.builtin.lineinfile:
    path: "/home/{{ k8s_admin_user }}/.bashrc"
    line: "export KUBECONFIG={{ k8s_kubeconfig_path }}"
    state: present
    create: yes

- name: Enable kubectl autocompletion
  ansible.builtin.lineinfile:
    path: "/home/{{ k8s_admin_user }}/.bashrc"
    line: "source <(kubectl completion bash)"
    state: present
    create: yes

- name: Verify kubectl access for user
  ansible.builtin.command: kubectl get nodes
  become: true
  become_user: "{{ k8s_admin_user }}"
  environment:
    KUBECONFIG: "{{ k8s_kubeconfig_path }}"
  register: kubectl_test
  changed_when: false
  retries: 3
  delay: 5
  until: kubectl_test.rc == 0
