name: ğŸš€ Auto PR Creation (Reusable)

on:
  workflow_call:
    inputs:
      repository_name:
        required: true
        type: string
        description: "Name of the repository (infra, client, api)"
      base_branch:
        required: false
        type: string
        default: "staging"
        description: "Base branch for PR creation"
      reviewers:
        required: false
        type: string
        description: "Comma-separated list of reviewers"
      team_reviewers:
        required: false
        type: string
        description: "Comma-separated list of team reviewers"
    secrets:
      AUTO_DEPLOY_TOKEN:
        required: true
        description: "GitHub token with push/PR permissions"

jobs:
  create-feature-pr:
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/staging' && github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.AUTO_DEPLOY_TOKEN }}

      - name: Check for gitmoji in latest commit
        id: gitmoji_check
        run: |
          COMMIT_MSG=$(git log -1 --format="%s")
          echo "Latest commit: $COMMIT_MSG"
          
          # Check for gitmoji patterns (emoji or :text: format)
          if [[ "$COMMIT_MSG" =~ (ğŸš‘|:ambulance:|âœ¨|:sparkles:|ğŸ›|:bug:|ğŸš€|:rocket:|â™»ï¸|:recycle:|ğŸ¨|:art:|ğŸ’„|:lipstick:|âš¡|:zap:|ğŸ”§|:wrench:|ğŸ“|:memo:|ğŸ”¥|:fire:|ğŸ’š|:green_heart:|â¬†ï¸|:arrow_up:|â¬‡ï¸|:arrow_down:|ğŸ“Œ|:pushpin:|ğŸ‘·|:construction_worker:|ğŸ“ˆ|:chart_with_upwards_trend:|ğŸ”¨|:hammer:|ğŸ‰|:tada:|ğŸ”’|:lock:|ğŸ”|:closed_lock_with_key:|ğŸ”‘|:key:|ğŸ—ï¸|:building_construction:|ğŸ“¦|:package:|ğŸ”–|:bookmark:|ğŸš¨|:rotating_light:|ğŸ’¡|:bulb:|ğŸ»|:beers:|ğŸ’¬|:speech_balloon:|ğŸ—ƒï¸|:card_file_box:|ğŸ”Š|:loud_sound:|ğŸ”‡|:mute:|ğŸ‘¥|:busts_in_silhouette:|ğŸš¸|:children_crossing:|ğŸ“±|:iphone:|ğŸ¤¡|:clown_face:|ğŸ¥…|:goal_net:|ğŸ“¸|:camera_flash:|âš—ï¸|:alembic:|ğŸ”|:mag:|ğŸ·ï¸|:label:|ğŸŒ±|:seedling:|ğŸš©|:triangular_flag_on_post:|ğŸ’«|:dizzy:|ğŸ—‘ï¸|:wastebasket:|ğŸ›‚|:passport_control:|ğŸ©¹|:adhesive_bandage:|ğŸ§|:monocle_face:|âš°ï¸|:coffin:|ğŸ§ª|:test_tube:|ğŸ‘”|:necktie:|ğŸ©º|:stethoscope:|ğŸ§±|:bricks:|ğŸ§‘â€ğŸ’»|:technologist:|ğŸ’¸|:money_with_wings:|ğŸ§µ|:thread:|ğŸ¦º|:safety_vest:) ]]; then
            echo "has_gitmoji=true" >> $GITHUB_OUTPUT
          
            # Determine priority based on gitmoji
            if [[ "$COMMIT_MSG" =~ (ğŸš‘|:ambulance:) ]]; then
              echo "priority=critical" >> $GITHUB_OUTPUT
            else
              echo "priority=normal" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_gitmoji=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Set repository-specific configurations
        id: repo_config
        run: |
          REPO_NAME="${{ inputs.repository_name }}"
          
          case "$REPO_NAME" in
            "infra")
              echo "emoji=ğŸ—ï¸" >> $GITHUB_OUTPUT
              echo "context=Infrastructure" >> $GITHUB_OUTPUT
              ;;
            "client")
              echo "emoji=ğŸ–¥ï¸" >> $GITHUB_OUTPUT
              echo "context=Frontend" >> $GITHUB_OUTPUT
              ;;
            "api")
              echo "emoji=ğŸ”Œ" >> $GITHUB_OUTPUT
              echo "context=Backend API" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "emoji=ğŸ”€" >> $GITHUB_OUTPUT
              echo "context=Code" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Create Pull Request
        if: steps.gitmoji_check.outputs.has_gitmoji == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.AUTO_DEPLOY_TOKEN }}
          branch: ${{ github.ref_name }}
          base: ${{ inputs.base_branch }}
          title: ${{ steps.gitmoji_check.outputs.priority == 'critical' && 'ğŸš‘ HOTFIX:' || steps.repo_config.outputs.emoji }} ${{ github.ref_name }} - ${{ steps.repo_config.outputs.context }}
          body: |
            ## ${{ steps.gitmoji_check.outputs.priority == 'critical' && 'ğŸš¨ Critical Hotfix' || format('{0} {1} Ready for Review', steps.repo_config.outputs.emoji, steps.repo_config.outputs.context) }}
            
            **Repository**: `${{ inputs.repository_name }}`  
            **Ticket**: ${{ github.ref_name }}  
            ${{ steps.gitmoji_check.outputs.priority == 'critical' && '**Priority**: Critical - Requires immediate review' || '' }}
            
            ### ğŸ“‹ Changes
            ```
            ${{ github.event.head_commit.message }}
            ```
            
            ### ğŸ” Review Checklist
            - [ ] Code follows project standards
            - [ ] Tests added/updated as needed
            - [ ] Documentation updated if required
            ${{ steps.gitmoji_check.outputs.priority == 'critical' && '- [ ] Hotfix tested and verified' || '' }}
            ${{ inputs.repository_name == 'infra' && '- [ ] Infrastructure changes reviewed for security' || '' }}
            ${{ inputs.repository_name == 'client' && '- [ ] UI/UX changes tested across browsers' || '' }}
            ${{ inputs.repository_name == 'api' && '- [ ] API changes backward compatible' || '' }}
            
            ### ğŸ“Š Repository Context
            This PR affects the **${{ steps.repo_config.outputs.context }}** components of the system.
            
            ---
            ğŸ¤– *Auto-created from gitmoji commit in `${{ inputs.repository_name }}` repository*
          labels: |
            ${{ steps.gitmoji_check.outputs.priority == 'critical' && 'hotfix' || 'feature' }}
            automated-pr
            ${{ inputs.repository_name }}
            ${{ github.ref_name }}
          reviewers: ${{ inputs.reviewers }}
          team-reviewers: ${{ inputs.team_reviewers }}
          draft: ${{ steps.gitmoji_check.outputs.priority != 'critical' }}

      - name: Comment if no gitmoji
        if: steps.gitmoji_check.outputs.has_gitmoji == 'false'
        run: |
          echo "â„¹ï¸  No gitmoji found in commit message. Skipping PR creation."
          echo "ğŸ’¡ Use gitmoji in your commit messages to auto-create PRs!"
          echo "ğŸ“– Learn more: https://gitmoji.dev"
          echo "ğŸ—ï¸ Repository: ${{ inputs.repository_name }}"