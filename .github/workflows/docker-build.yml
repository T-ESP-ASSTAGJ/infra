name: Docker Build & Push

on:
  workflow_call:
    inputs:
      context_path:
        description: 'Docker build context path'
        type: string
        default: '.'
      dockerfile:
        description: 'Path to Dockerfile'
        type: string
        default: 'Dockerfile'
      image_name:
        description: 'Full image name (ex: ghcr.io/org/app-name)'
        type: string
        required: true
      build_target:
        description: 'Docker build target stage'
        type: string
        required: false
      branch:
        description: 'Current branch name'
        type: string
        required: true
      should_push:
        description: 'Whether to push the image to registry'
        type: boolean
        default: true
    secrets:
      GHCR_TOKEN:
        description: 'GitHub token for registry access'
        required: true
      APP_SECRET:
        description: 'Application secret for .env.local'
        required: false
      DATABASE_URL:
        description: 'Database URL for .env.local'
        required: false
      MERCURE_JWT_SECRET:
        description: 'Mercure JWT secret for .env.local'
        required: false
    outputs:
      image_url:
        description: 'Built image URL without tag'
        value: ${{ jobs.build.outputs.image_url }}
      image_tag:
        description: 'Built image tag (SHA)'
        value: ${{ jobs.build.outputs.image_tag }}
      full_image:
        description: 'Complete image reference (url:tag)'
        value: ${{ jobs.build.outputs.full_image }}

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_url: ${{ steps.meta.outputs.image_url }}
      image_tag: ${{ steps.meta.outputs.image_tag }}
      full_image: ${{ steps.meta.outputs.full_image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image metadata
        id: meta
        run: |
          IMAGE_TAG="${{ github.sha }}"
          FULL_IMAGE="${{ inputs.image_name }}:${IMAGE_TAG}"
          
          echo "image_url=${{ inputs.image_name }}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ Image: ${FULL_IMAGE}"

      - name: Login to GitHub Container Registry
        if: inputs.should_push
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ inputs.GHCR_TOKEN }}

      - name: Create .env.local with secrets
        run: |
          # Le [ -n ] vÃ©rifie si la variable est non-vide avant d'Ã©crire
          [ -n "${{ secrets.APP_SECRET }}" ] && echo "APP_SECRET=${{ secrets.APP_SECRET }}" >> .env.local
          [ -n "${{ secrets.DATABASE_URL }}" ] && echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env.local
          [ -n "${{ secrets.MERCURE_JWT_SECRET }}" ] && echo "MERCURE_JWT_SECRET=${{ secrets.MERCURE_JWT_SECRET }}" >> .env.local

          echo "MERCURE_URL=https://example.com/.well-known/mercure" >> .env.local
          echo "MERCURE_PUBLIC_URL=https://example.com/.well-known/mercure" >> .env.local

          echo "âœ… .env.local created (with provided secrets)"

      - name: Build Docker image
        run: |
          BUILD_CMD="docker build"
          BUILD_CMD="${BUILD_CMD} -t ${{ steps.meta.outputs.full_image }}"
          
          # Add target if specified
          if [ -n "${{ inputs.build_target }}" ]; then
            BUILD_CMD="${BUILD_CMD} --target ${{ inputs.build_target }}"
            echo "ğŸ¯ Using build target: ${{ inputs.build_target }}"
          fi
          
          BUILD_CMD="${BUILD_CMD} -f ${{ inputs.dockerfile }} ${{ inputs.context_path }}"
          
          echo "ğŸ³ Building Docker image..."
          echo "Command: ${BUILD_CMD}"
          eval $BUILD_CMD
          
          echo "âœ… Image built successfully"

      - name: Push Docker image
        if: inputs.should_push
        run: |
          echo "ğŸ“¤ Pushing image to registry..."
          docker push ${{ steps.meta.outputs.full_image }}
          
          # Tag and push 'latest' only for main branch
          if [ "${{ inputs.branch }}" == "main" ]; then
            echo "ğŸ·ï¸ Tagging as latest..."
            docker tag ${{ steps.meta.outputs.full_image }} ${{ inputs.image_name }}:latest
            docker push ${{ inputs.image_name }}:latest
            echo "âœ… Latest tag pushed"
          fi
          
          echo "âœ… Image pushed to ${{ steps.meta.outputs.full_image }}"