name: üìã PR Reminder Bot

on:
  schedule:
    # Run Monday-Friday at 2:00 PM UTC (14h)
    - cron: '0 14 * * 1-5'

  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  check-open-prs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for open pull requests across all repos
        id: check-prs
        run: |
          # List of repositories to check
          REPOS=("T-ESP-ASSTAGJ/api" "T-ESP-ASSTAGJ/client" "T-ESP-ASSTAGJ/infra")
          
          # Initialize combined PR list
          echo "[]" > combined_prs.json
          TOTAL_PR_COUNT=0
          
          # Check each repository
          for repo in "${REPOS[@]}"; do
            echo "Checking repository: $repo"
          
            # Get PRs for this repo
            REPO_PRS=$(gh pr list --repo "$repo" --json number,title,author,createdAt,url,headRefName --limit 20)
            REPO_PR_COUNT=$(echo "$REPO_PRS" | jq '. | length')
          
            echo "Found ${REPO_PR_COUNT} PRs in $repo"
          
            # Add repository info to each PR
            REPO_PRS_WITH_INFO=$(echo "$REPO_PRS" | jq --arg repo "$repo" 'map(. + {repository: $repo})')
          
            # Combine with existing PRs
            combined_prs=$(jq -s '.[0] + .[1]' combined_prs.json <(echo "$REPO_PRS_WITH_INFO"))
            echo "$combined_prs" > combined_prs.json
          
            TOTAL_PR_COUNT=$((TOTAL_PR_COUNT + REPO_PR_COUNT))
          done
          
          echo "pr_count=${TOTAL_PR_COUNT}" >> $GITHUB_OUTPUT
          
          # Save combined PR data
          cp combined_prs.json open_prs.json
          
          echo "Found ${TOTAL_PR_COUNT} total open pull requests across all repositories"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare Discord message
        id: discord-prep
        if: steps.check-prs.outputs.pr_count > 0
        run: |
          PR_COUNT=${{ steps.check-prs.outputs.pr_count }}
          
          # Use mixed color for all repositories combined
          COLOR="5793266"      # Blue for combined view
          
          # Build title based on PR count
          if [[ $PR_COUNT -eq 1 ]]; then
            TITLE="üìã 1 Pull Request Needs Attention!"
          else
            TITLE="üìã ${PR_COUNT} Pull Requests Need Attention!"
          fi
          
          # Create PR list for description with repository names
          PR_LIST=$(jq -r '.[] | "‚Ä¢ **[\(.repository | split("/")[1])](https://github.com/\(.repository))** - **[\(.title)](\(.url))** by \(.author.login) (\(.headRefName))"' open_prs.json | head -10)
          
          # If more than 10 PRs, add a note
          if [[ $PR_COUNT -gt 10 ]]; then
            PR_LIST="${PR_LIST}\n‚Ä¢ ... and $((PR_COUNT - 10)) more"
          fi
          
          # Set outputs
          echo "color=${COLOR}" >> $GITHUB_OUTPUT
          echo "title=${TITLE}" >> $GITHUB_OUTPUT
          echo "pr_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "${PR_LIST}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Discord reminder
        if: steps.check-prs.outputs.pr_count > 0
        run: |
          # Create timestamp
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)
          UNIX_TIMESTAMP=$(date +%s)
          
          # Get oldest PR for additional info
          OLDEST_PR=$(jq -r 'sort_by(.createdAt) | .[0]' open_prs.json)
          OLDEST_DAYS=$(( ($(date +%s) - $(date -d "$(echo "$OLDEST_PR" | jq -r '.createdAt')" +%s)) / 86400 ))
          
          # Build Discord payload using jq
          jq -n \
            --arg title "${{ steps.discord-prep.outputs.title }}" \
            --arg pr_list "${{ steps.discord-prep.outputs.pr_list }}" \
            --argjson color "${{ steps.discord-prep.outputs.color }}" \
            --arg pr_count "${{ steps.check-prs.outputs.pr_count }}" \
            --arg oldest_days "${OLDEST_DAYS}" \
            --arg timestamp "${TIMESTAMP}" \
            --argjson unix_timestamp "${UNIX_TIMESTAMP}" \
            '{
              "embeds": [
                {
                  "title": $title,
                  "description": $pr_list,
                  "color": $color,
                  "fields": [

                    {
                      "name": "üìä Total PRs",
                      "value": $pr_count,
                      "inline": true
                    },
                    {
                      "name": "‚è∞ Oldest PR",
                      "value": "\($oldest_days) days old",
                      "inline": true
                    },
                    {
                      "name": "üïí Time",
                      "value": "<t:\($unix_timestamp):R>",
                      "inline": true
                    },
                    {
                      "name": "üîó Quick Actions",
                      "value": "[API PRs](https://github.com/T-ESP-ASSTAGJ/api/pulls) ‚Ä¢ [Client PRs](https://github.com/T-ESP-ASSTAGJ/client/pulls) ‚Ä¢ [Infra PRs](https://github.com/T-ESP-ASSTAGJ/infra/pulls)",
                      "inline": false
                    }
                  ],
                  "timestamp": $timestamp,
                  "footer": {
                    "text": "T-ESP-ASSTAGJ ‚Ä¢ GitHub Actions",
                    "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                  }
                }
              ]
            }' > discord_payload.json
          
          # Send to Discord using the PR reminder webhook
          HTTP_RESPONSE=$(curl -s -w "%{http_code}" \
                              -H "Content-Type: application/json" \
                              -d @discord_payload.json \
                              "${{ secrets.PR_REMINDER_WEBHOOK_URL }}")
          
          HTTP_CODE=${HTTP_RESPONSE: -3}
          
          if [[ $HTTP_CODE -ge 200 && $HTTP_CODE -lt 300 ]]; then
            echo "‚úÖ PR reminder sent successfully! (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Failed to send PR reminder. HTTP Code: $HTTP_CODE"
            echo "Response: ${HTTP_RESPONSE%???}"
            exit 1
          fi
        env:
          PR_REMINDER_WEBHOOK_URL: ${{ secrets.PR_REMINDER_WEBHOOK_URL }}

      - name: No PRs message
        if: steps.check-prs.outputs.pr_count == 0
        run: |
          echo "üéâ No open pull requests found! Great job keeping up with reviews."